<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <!-- Generated with Sphinx 8.2.3 and Furo 2025.07.19 -->
        <title>walytis_beta.walytis_beta - walytis_beta 0.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=25af2a20" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../README.html"><div class="brand">walytis_beta 0.0.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../README.html">
  
  <span class="sidebar-brand-text">walytis_beta 0.0.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../walytis_beta_api.blockchain_model.html">walytis_beta_api.blockchain_model module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../walytis_beta_api.walytis_beta_interface.html">walytis_beta_api.walytis_beta_interface module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../walytis_beta_tools.block_model.html">walytis_beta_tools.block_model module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../walytis_beta_tools.exceptions.html">walytis_beta_tools.exceptions module</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for walytis_beta.walytis_beta</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Core Walytis blockchain functionality.&quot;&quot;&quot;</span>
<span class="c1"># pylint: disable=import-error</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.walytis_beta_appdata</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">BlockchainAppdata</span><span class="p">,</span>
    <span class="n">create_temp_dir</span><span class="p">,</span>
    <span class="n">get_walytis_appdata_dir</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.networking</span><span class="w"> </span><span class="kn">import</span> <span class="n">Networking</span><span class="p">,</span> <span class="n">ipfs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">BlockchainNotInitialised</span><span class="p">,</span> <span class="n">BlockchainTerminatedError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.block_records</span><span class="w"> </span><span class="kn">import</span> <span class="n">BlockRecords</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.block_networking</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Block</span><span class="p">,</span>
    <span class="n">IpfsCidExistsError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">walytis_beta_api_terminal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">random</span><span class="w"> </span><span class="kn">import</span> <span class="n">randint</span><span class="p">,</span> <span class="n">seed</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">threading</span><span class="w"> </span><span class="kn">import</span> <span class="n">Lock</span><span class="p">,</span> <span class="n">Thread</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">sleep</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">brenthy_tools_beta.utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">are_elements_unique</span><span class="p">,</span>
    <span class="n">bytes_to_string</span><span class="p">,</span>
    <span class="n">decode_timestamp</span><span class="p">,</span>
    <span class="n">from_b255_no_0s</span><span class="p">,</span>
    <span class="n">function_name</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">brenthy_tools_beta.version_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">decode_version</span><span class="p">,</span> <span class="n">is_version_greater</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ecies.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_key</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">walytis_beta_tools.block_model</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">decode_long_id</span><span class="p">,</span>
    <span class="n">decode_short_id</span><span class="p">,</span>
    <span class="n">short_from_long_id</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">walytis_beta_tools.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">NotSupposedToHappenError</span>

<span class="c1"># import api_terminal as AppCom</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">walytis_beta_tools.log</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span><span class="p">,</span> <span class="n">logger_join</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">walytis_beta_tools.versions</span><span class="w"> </span><span class="kn">import</span> <span class="n">WALYTIS_BETA_CORE_VERSION</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="n">logger_join</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="c1"># a variable with this blockchain&#39;s name so that we don&#39;t missspell it</span>
<span class="n">WALYTIS_BETA</span> <span class="o">=</span> <span class="s2">&quot;Walytis_Beta&quot;</span>

<span class="c1"># from brenthy_tools_beta.utils import string_to_bytes, bytes_to_string</span>
<span class="n">N_GENESIS_BLOCKS</span> <span class="o">=</span> <span class="mi">5</span>
<span class="c1"># how many blocks we load at startup</span>
<span class="c1"># for use as potential parent blocks for blocks we create</span>
<span class="n">N_STARTUP_ENDBLOCKS</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">JOIN_COMMS_TIMEOUT_S</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">JOIN_COMMS_FILE_TIMEOUT_S</span> <span class="o">=</span> <span class="mi">30</span>


<div class="viewcode-block" id="Blockchain">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.Blockchain">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Blockchain</span><span class="p">(</span><span class="n">BlockchainAppdata</span><span class="p">,</span> <span class="n">BlockRecords</span><span class="p">,</span> <span class="n">Networking</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The Walytis_Beta blockchain.</span>

<span class="sd">    Brenthy can run any number of blockchain types.</span>
<span class="sd">    This is the blockchain whose invention lead to the development of Brenthy.</span>

<span class="sd">    OOOOOOOOOO</span>
<span class="sd">    OOἅλυσιςOO</span>
<span class="sd">    OOOOOOOOOO</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">blocks_finder_thread_cycle_duration_s</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">create_block_lock</span><span class="p">:</span> <span class="n">Lock</span>
    <span class="n">genesis</span><span class="p">:</span> <span class="nb">bool</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load an existing blockchain, or creat a new one.</span>

<span class="sd">        Loads an existing blockchain from appdata if `id` is specified,</span>
<span class="sd">        otherwise it creates a new Blockchain.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="c1"># list of parent short_ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_endblocks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bytearray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unconfirmed_blocks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Block</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocks_to_find</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bytearray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list(short_id)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">invitations</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_block_lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>  <span class="c1"># ensures sequential block creation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endblocks_lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>  <span class="c1"># for accessing current_endblocks</span>
        <span class="c1"># lock for accessing unconfirmed_blocks and blocks_to_find</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocks_to_confirm_lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_terminate</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># flag when we&#39;re shutting down</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_genesis</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ipfs_peer_id</span> <span class="o">=</span> <span class="n">ipfs</span><span class="o">.</span><span class="n">peer_id</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">id</span><span class="p">:</span>
            <span class="c1"># Create new blockchain:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blockchain_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__birth</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Using existing blockchain:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">error_message</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Parameter id must be of type str, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blockchain_id</span> <span class="o">=</span> <span class="nb">id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">appdata_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">get_walytis_appdata_dir</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">blockchain_id</span>
            <span class="p">)</span>
            <span class="n">BlockchainAppdata</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">BlockRecords</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_block_records</span><span class="p">()</span>
            <span class="n">Networking</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blockchain_id</span><span class="p">[:</span><span class="mi">14</span><span class="p">]</span>

            <span class="c1"># create a list of blocks to use as parents for block creation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_endblocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_ancestors</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">short_from_long_id</span><span class="p">(</span><span class="n">long_id</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">long_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_latest_block_ids</span><span class="p">(</span>
                        <span class="n">N_STARTUP_ENDBLOCKS</span>
                    <span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">listen_for_blocks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_finder_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks_finder_thread</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(),</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;BlocksFinderThread&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_finder_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv_lis</span> <span class="o">=</span> <span class="n">ipfs</span><span class="o">.</span><span class="n">listen_for_conversations</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">blockchain_id</span><span class="si">}</span><span class="s2">: JoinRequest&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_join_request_received</span>
        <span class="p">)</span>

        <span class="c1"># run the loop that asks othe rnodes for their latest blocks</span>
        <span class="c1"># when the block publishing pubsub channel gets too quiet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_requester_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">leaf_blocks_broadcaster</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(),</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;BlockRequesterThread&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_requester_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__birth</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform the blockchain creation procedure.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_genesis</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_alive</span><span class="p">()</span>  <span class="c1"># ensure this Blockchain object isn&#39;t shutting down</span>

        <span class="c1"># initialise the part of the uninitialised BlockRecords which we need</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_id_cache</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">seed</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">microsecond</span><span class="p">)</span>
        <span class="n">genesis_blocks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating genesis blocks...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_known_ids</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_GENESIS_BLOCKS</span><span class="p">):</span>
            <span class="n">block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_block</span><span class="p">(</span>
                <span class="s2">&quot;Hello World, new blockchain getting born!&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
                <span class="o">+</span> <span class="nb">bytearray</span><span class="p">([</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">)]),</span>
            <span class="p">)</span>
            <span class="n">genesis_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_genesis_block_id</span> <span class="o">=</span> <span class="n">genesis_blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">long_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__born</span><span class="p">(</span><span class="n">genesis_blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_genesis_block_id</span> <span class="o">=</span> <span class="n">genesis_blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">long_id</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Storing genesis blocks...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_endblocks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">genesis_blocks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">download_and_process_block</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">short_id</span><span class="p">)</span>

        <span class="c1"># self.number_of_known_ids = len(genesis_blocks)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_genesis</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">genesis_blocks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">publish_new_block</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished processing Genesis blocks!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listen_for_blocks</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__born</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">genesis_block</span><span class="p">:</span> <span class="n">Block</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform operation needed as soon as the genesis block is created.&quot;&quot;&quot;</span>
        <span class="c1"># skip if this function has already been executed by thge genesis block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_alive</span><span class="p">()</span>  <span class="c1"># ensure this Blockchain object isn&#39;t shutting down</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">blockchain_id</span> <span class="o">=</span> <span class="n">genesis_block</span><span class="o">.</span><span class="n">ipfs_cid</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blockchain_id</span><span class="p">[:</span><span class="mi">14</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">appdata_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">get_walytis_appdata_dir</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">blockchain_id</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">appdata_dir</span><span class="p">):</span>
            <span class="n">backup_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">appdata_dir</span> <span class="o">+</span> <span class="s2">&quot;_BACKUP&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;This shouldn&#39;t happen but it has: Appdata path &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;already exists for blockchain </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Moving it to </span><span class="si">{</span><span class="n">backup_path</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">backup_path</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">backup_path</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;This shouldn&#39;t happen but it has: Backup &quot;</span>
                    <span class="s2">&quot;path for appdata already exists! Overwriting :(&quot;</span>
                <span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">appdata_dir</span><span class="p">,</span> <span class="n">backup_path</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">appdata_dir</span><span class="p">)</span>
        <span class="n">BlockchainAppdata</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">BlockRecords</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_block_records</span><span class="p">(</span><span class="n">genesis_block</span><span class="o">.</span><span class="n">creation_time</span><span class="p">)</span>
        <span class="n">Networking</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="Blockchain.create_block">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.Blockchain.create_block">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_block</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">bytearray</span> <span class="o">|</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">topics</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Block</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new block, adding it to this blockchain.</span>

<span class="sd">        Args:</span>
<span class="sd">            content: the content which you want to store in this block</span>
<span class="sd">            topics: optional labels for this block to aid in the user&#39;s</span>
<span class="sd">                        sorting of blocks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_alive</span><span class="p">()</span>  <span class="c1"># ensure this Blockchain object isn&#39;t shutting down</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">topics</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">topics</span> <span class="o">=</span> <span class="p">[</span><span class="n">topics</span><span class="p">]</span>
        <span class="c1"># if we&#39;re creating a genesis block</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_genesis</span><span class="p">:</span>
            <span class="n">topics</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;genesis&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;genesis&quot;</span> <span class="ow">in</span> <span class="n">topics</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;I won&#39;t create a block with topic &#39;genesis&#39;&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">blockchain_id</span><span class="p">:</span>
            <span class="c1"># safety check</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_genesis</span><span class="p">:</span>
                <span class="n">error_message</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;CreateBlock: Blockchain id is not yet &quot;</span>
                    <span class="s2">&quot;defined and this block is not marked as a genesis block&quot;</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">BlockchainNotInitialised</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">blockchain_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">topics</span><span class="p">:</span>
            <span class="n">topics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blockchain_id</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  Creating block for </span><span class="si">{</span><span class="n">topics</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_block_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">block_blockchain_version</span> <span class="o">=</span> <span class="n">WALYTIS_BETA_CORE_VERSION</span>
        <span class="n">block_content</span> <span class="o">=</span> <span class="n">content</span>
        <span class="n">block_creation_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">block_parents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Adding parent blocks</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">endblocks_lock</span><span class="p">:</span>
            <span class="n">block_parents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_ancestors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_endblocks</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_endblocks</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># clear current_endblocks</span>

        <span class="c1"># if parents is only one block, add genesis block</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">block_parents</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">block_parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short_from_long_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_genesis_block</span><span class="p">()))</span>
        <span class="c1"># sort parent blocks</span>
        <span class="n">block_parents</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="c1"># ensure that all parent blocks have older timestamps than this block</span>
        <span class="k">if</span> <span class="p">[</span>
            <span class="n">prnt_id</span>
            <span class="k">for</span> <span class="n">prnt_id</span> <span class="ow">in</span> <span class="n">block_parents</span>
            <span class="k">if</span> <span class="n">decode_short_id</span><span class="p">(</span><span class="n">prnt_id</span><span class="p">)[</span><span class="s2">&quot;creation_time&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">block_creation_time</span>
        <span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_block_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

            <span class="n">error_message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;walytis_beta.Blockchain.create_block: Parent block&#39;s creation&quot;</span>
                <span class="s2">&quot; time is greater than this block&#39;s creation time &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">block_creation_time</span><span class="si">}</span><span class="s2">. This is a bug because it should have &quot;</span>
                <span class="s2">&quot;been checked before.&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">NotSupposedToHappenError</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>

        <span class="n">block_creator_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipfs_peer_id</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">block_topics</span> <span class="o">=</span> <span class="n">topics</span>
        <span class="n">block_content_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">block_content</span><span class="p">)</span>
        <span class="n">block_n_parents</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">block_parents</span><span class="p">)</span>

        <span class="n">block</span> <span class="o">=</span> <span class="n">Block</span><span class="o">.</span><span class="n">from_metadata</span><span class="p">(</span>
            <span class="n">creator_id</span><span class="o">=</span><span class="n">block_creator_id</span><span class="p">,</span>
            <span class="n">creation_time</span><span class="o">=</span><span class="n">block_creation_time</span><span class="p">,</span>
            <span class="n">topics</span><span class="o">=</span><span class="n">block_topics</span><span class="p">,</span>
            <span class="n">content_length</span><span class="o">=</span><span class="n">block_content_length</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">content</span><span class="p">),</span>
            <span class="n">n_parents</span><span class="o">=</span><span class="n">block_n_parents</span><span class="p">,</span>
            <span class="n">parents</span><span class="o">=</span><span class="n">block_parents</span><span class="p">,</span>
            <span class="n">blockchain_version</span><span class="o">=</span><span class="n">block_blockchain_version</span><span class="p">,</span>
            <span class="n">ipfs_cid</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">content_hash_algorithm</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">content_hash</span><span class="o">=</span><span class="nb">bytearray</span><span class="p">(),</span>
            <span class="n">parents_hash_algorithm</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">parents_hash</span><span class="o">=</span><span class="nb">bytearray</span><span class="p">(),</span>
            <span class="n">file_data</span><span class="o">=</span><span class="nb">bytearray</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">finish_and_publish_block</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">block</span><span class="o">.</span><span class="n">_creation_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="n">block</span><span class="o">.</span><span class="n">generate_content_hash</span><span class="p">()</span>
            <span class="n">block</span><span class="o">.</span><span class="n">generate_parents_hash</span><span class="p">()</span>
            <span class="n">block</span><span class="o">.</span><span class="n">generate_file_data</span><span class="p">()</span>

            <span class="n">block</span><span class="o">.</span><span class="n">publish_and_generate_id</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blockchain_id</span><span class="p">,</span> <span class="n">skip_pubsub</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_genesis</span>
            <span class="p">)</span>

        <span class="c1"># Try building and publishing the block.</span>
        <span class="c1"># If another file on IPFS already has the block&#39;s predicted CID,</span>
        <span class="c1"># retry building block with new timestamp.</span>
        <span class="n">published</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">published</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">finish_and_publish_block</span><span class="p">()</span>
                <span class="n">published</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="n">IpfsCidExistsError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;walytis_beta.create_block: retrying block creation with &quot;</span>
                    <span class="s2">&quot;new timestamp&quot;</span>
                <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  Finished building block.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_genesis</span><span class="p">:</span>
            <span class="c1"># logger.info(f&quot;{self.name}:  Genesis block!&quot;)</span>
            <span class="c1"># manually cache block because BlockRecords isn&#39;t initialised</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_block</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">long_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_new_block</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">endblocks_lock</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">short_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_endblocks</span><span class="p">:</span>
                <span class="c1"># add block to current_endblocks, remove ancestors</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_endblocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_ancestors</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current_endblocks</span> <span class="o">+</span> <span class="p">[</span><span class="n">block</span><span class="o">.</span><span class="n">short_id</span><span class="p">]</span>
                <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  Finished adding new block to the blockchain.&quot;</span>
        <span class="p">)</span>

        <span class="c1"># DEBUG</span>
        <span class="n">long_id</span> <span class="o">=</span> <span class="n">decode_long_id</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">long_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">ipfs_cid</span> <span class="o">!=</span> <span class="n">long_id</span><span class="p">[</span><span class="s2">&quot;ipfs_cid&quot;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  MISMATCH ipfs_cid &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">ipfs_cid</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot; != &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">long_id</span><span class="p">[</span><span class="s2">&quot;ipfs_cid&quot;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">creator_id</span> <span class="o">!=</span> <span class="n">long_id</span><span class="p">[</span><span class="s2">&quot;creator_id&quot;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  MISMATCH creator_id &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">creator_id</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot; != &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">long_id</span><span class="p">[</span><span class="s2">&quot;creator_id&quot;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">creation_time</span> <span class="o">!=</span> <span class="n">long_id</span><span class="p">[</span><span class="s2">&quot;creation_time&quot;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  MISMATCH creation_time &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">creation_time</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot; != &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">long_id</span><span class="p">[</span><span class="s2">&quot;creation_time&quot;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">topics</span> <span class="o">!=</span> <span class="n">long_id</span><span class="p">[</span><span class="s2">&quot;topics&quot;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  MISMATCH topics &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">topics</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot; != &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">long_id</span><span class="p">[</span><span class="s2">&quot;topics&quot;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">_content_length</span> <span class="o">!=</span> <span class="n">long_id</span><span class="p">[</span><span class="s2">&quot;content_length&quot;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  MISMATCH content_length &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">_content_length</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot; != &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">long_id</span><span class="p">[</span><span class="s2">&quot;content_length&quot;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">_n_parents</span> <span class="o">!=</span> <span class="n">long_id</span><span class="p">[</span><span class="s2">&quot;n_parents&quot;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  MISMATCH n_parents &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">_n_parents</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot; != &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">long_id</span><span class="p">[</span><span class="s2">&quot;n_parents&quot;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">_content_hash_algorithm</span> <span class="o">!=</span> <span class="n">long_id</span><span class="p">[</span><span class="s2">&quot;content_hash_algorithm&quot;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  MISMATCH content_hash_algorithm &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">_content_hash_algorithm</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot; != &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">long_id</span><span class="p">[</span><span class="s2">&quot;content_hash_algorithm&quot;</span><span class="p">])</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">_content_hash</span> <span class="o">!=</span> <span class="n">long_id</span><span class="p">[</span><span class="s2">&quot;content_hash&quot;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  MISMATCH hash &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">_content_hash</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot; != &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">long_id</span><span class="p">[</span><span class="s2">&quot;content_hash&quot;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">_parents_hash</span> <span class="o">!=</span> <span class="n">long_id</span><span class="p">[</span><span class="s2">&quot;parents_hash&quot;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  MISMATCH hash &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">_parents_hash</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot; != &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">long_id</span><span class="p">[</span><span class="s2">&quot;parents_hash&quot;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">parents</span> <span class="o">!=</span> <span class="n">long_id</span><span class="p">[</span><span class="s2">&quot;parents&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">parents</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">long_id</span><span class="p">[</span><span class="s2">&quot;parents&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  MISMATCH parents&quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">parents</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot; != &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">long_id</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_block_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_genesis</span><span class="p">:</span>
            <span class="c1"># inform applications about the new block</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">publish_new_block</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">block</span></div>


<div class="viewcode-block" id="Blockchain.publish_new_block">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.Blockchain.publish_new_block">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">publish_new_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="n">Block</span><span class="p">):</span>
        <span class="n">walytis_beta_api_terminal</span><span class="o">.</span><span class="n">publish_event</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blockchain_id</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;block_id&quot;</span><span class="p">:</span> <span class="n">bytes_to_string</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">short_id</span><span class="p">)},</span>
            <span class="n">topics</span><span class="o">=</span><span class="s2">&quot;NewBlocks&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Blockchain.new_block_published">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.Blockchain.new_block_published">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">new_block_published</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short_id</span><span class="p">:</span> <span class="nb">bytearray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Eventhandler for when a notification of a new block is received.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_alive</span><span class="p">()</span>  <span class="c1"># ensure this Blockchain object isn&#39;t shutting down</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  Received new block.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">download_and_process_block</span><span class="p">(</span><span class="n">short_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="Blockchain.download_and_process_block">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.Blockchain.download_and_process_block">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">download_and_process_block</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">long_id</span><span class="p">:</span> <span class="nb">bytearray</span><span class="p">,</span> <span class="n">live</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Block</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Download a new block, add it to our block history if it is ok.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_alive</span><span class="p">()</span>  <span class="c1"># ensure this Blockchain object isn&#39;t shutting down</span>

        <span class="c1"># when blockchain is being born, wait for genesis blocks to be created,</span>
        <span class="c1"># Blockchain ID determined, and all systems to start up</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_record_initialised</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="c1"># get block datafile from IPFS</span>
        <span class="n">short_id</span> <span class="o">=</span> <span class="n">short_from_long_id</span><span class="p">(</span><span class="n">long_id</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ipfs_cid</span> <span class="o">=</span> <span class="n">decode_short_id</span><span class="p">(</span><span class="n">short_id</span><span class="p">)[</span><span class="s2">&quot;ipfs_cid&quot;</span><span class="p">]</span>
            <span class="c1"># get block datafile from IPFS</span>
            <span class="n">block_data</span> <span class="o">=</span> <span class="n">ipfs</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ipfs_cid</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: Received data but failed to &quot;</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;find block.</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">Block ID: </span><span class="se">\n</span><span class="si">{</span><span class="n">short_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">block</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_block</span><span class="p">(</span><span class="n">block_data</span><span class="p">,</span> <span class="n">ipfs_cid</span><span class="p">,</span> <span class="n">live</span><span class="o">=</span><span class="n">live</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>  <span class="c1"># if file data seems corrupt</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">important</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  Failed to build block. Removing block-file &quot;</span>
                <span class="s2">&quot;from IPFS storage&quot;</span>
            <span class="p">)</span>
            <span class="c1"># remove block-file from IPFS storage</span>
            <span class="n">ipfs</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ipfs_cid</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">block</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">important</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  Failed to load and add block.&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  Block was processed.&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">short_id</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">short_id</span> <span class="o">=</span> <span class="n">short_id</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">short_id</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">short_id</span><span class="p">):</span>  <span class="c1"># suspicious</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: The decoded block&#39;s ID is not the &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;same as the one we are looking for.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Looking for: </span><span class="si">{</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">short_id</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Generated from BlockData: </span><span class="si">{</span><span class="n">block</span><span class="o">.</span><span class="n">short_id</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Doing all the necessary management</span>
        <span class="c1"># when a new block has been decoded and confirmed:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">on_block_confirmed</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  Finished processing new block.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">block</span></div>


<div class="viewcode-block" id="Blockchain.on_block_confirmed">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.Blockchain.on_block_confirmed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_block_confirmed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="n">Block</span><span class="p">):</span>
        <span class="c1"># if the block is not already known to us</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_new_block</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">endblocks_lock</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">short_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_endblocks</span><span class="p">:</span>
                    <span class="c1"># add block to current_endblocks, remove ancestors</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current_endblocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_ancestors</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">current_endblocks</span> <span class="o">+</span> <span class="p">[</span><span class="n">block</span><span class="o">.</span><span class="n">short_id</span><span class="p">]</span>
                    <span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  sending received block to &quot;</span> <span class="o">+</span> <span class="s2">&quot;applications...&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_genesis</span><span class="p">:</span>
                <span class="c1"># inform applications about the new block</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">publish_new_block</span><span class="p">(</span><span class="n">block</span><span class="p">)</span></div>


<div class="viewcode-block" id="Blockchain.read_block">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.Blockchain.read_block">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_block</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">block_data</span><span class="p">:</span> <span class="nb">bytearray</span> <span class="o">|</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">ipfs_cid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">live</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Block</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read a block file, returning a Block object if it is valid.</span>

<span class="sd">        Reads a block data file, decoding it, extracting its metadata.</span>
<span class="sd">        Unless the `live` parameter is set to False, this block&#39;s validity in</span>
<span class="sd">        the context of this blockchain will be checked, is registered</span>
<span class="sd">        in this blockchain&#39;s block archive etc.</span>

<span class="sd">        Args:</span>
<span class="sd">            block_data (bytearray): the block-file&#39;s data of the block to read.</span>
<span class="sd">            ipfs_cid (str): the IPFS CID the published block-file had</span>
<span class="sd">            live (bool): if True, this block processes of handling a new block</span>
<span class="sd">                in the context of a running blockchain will be performed, such</span>
<span class="sd">                as will have its parents checked, adding the block to the list</span>
<span class="sd">                of unconfirmed blocks, adding this block&#39;s unknown parents to</span>
<span class="sd">                self.blocks_to_find etc.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Block | None: A block object, compiled from reading the block data.</span>
<span class="sd">                If block data is invalid, or live==true and the block hasn&#39;t</span>
<span class="sd">                been confirmed, None is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_alive</span><span class="p">()</span>  <span class="c1"># ensure this Blockchain object isn&#39;t shutting down</span>

        <span class="k">if</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unconfirmed_blocks</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">ipfs_cid</span> <span class="o">==</span> <span class="n">ipfs_cid</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  read_block: this block is already in our &quot;</span>
                <span class="s2">&quot;unconfirmed_blocks list &quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># if self.is_block_cid_known(ipfs_cid):</span>
        <span class="c1">#     logger.debug(</span>
        <span class="c1">#         f&quot;{self.name}:  read_block: we already know this block.&quot;</span>
        <span class="c1">#     )</span>
        <span class="c1">#     return self.load_block_from_cid(ipfs_cid)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  read_block: Decoding block &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;(live)&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">live</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;(not live)&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># making a copy of the data to work with</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">block_data</span><span class="p">)</span>

        <span class="n">blockchain_version</span> <span class="o">=</span> <span class="n">decode_version</span><span class="p">(</span>
            <span class="n">data</span><span class="p">[:</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))]</span>
        <span class="p">)</span>

        <span class="c1"># If the block has a greater major version than the Walytis_Beta</span>
        <span class="c1"># version we are, we can&#39;t process this block, so return</span>
        <span class="k">if</span> <span class="n">is_version_greater</span><span class="p">(</span>
            <span class="n">blockchain_version</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">WALYTIS_BETA_CORE_VERSION</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Walytis_Beta.read_block: can&#39;t process block with newer &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Walytis_Beta version. Block: </span><span class="si">{</span><span class="n">blockchain_version</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Us: </span><span class="si">{</span><span class="n">WALYTIS_BETA_CORE_VERSION</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># extract metadata block (separated from content by [0,0,0,0,0])</span>
        <span class="c1"># and splt it into is subcomponents separated by [0,0]</span>
        <span class="n">content_separator</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="n">blockfile_header</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">content_separator</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
            <span class="nb">bytearray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">blockfile_header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="c1"># logger.important(data)</span>
        <span class="c1"># logger.important(blockfile_header)</span>
        <span class="c1"># logger.important(metadata)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blockfile_header</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">parents</span> <span class="o">=</span> <span class="n">blockfile_header</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parents</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># logger.important(&quot;Genesis block&quot;)</span>
        <span class="c1"># content sits between metadata and block_hash</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">content_separator</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">:]</span>

        <span class="c1"># # duplicate</span>
        <span class="c1"># blockchain_version = decode_version(metadata[0])</span>
        <span class="n">creator_id</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">creation_time</span> <span class="o">=</span> <span class="n">decode_timestamp</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">topics</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">topic</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">([</span><span class="mi">0</span><span class="p">]))</span>
        <span class="p">]</span>
        <span class="n">content_length</span> <span class="o">=</span> <span class="n">from_b255_no_0s</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">content_hash_algorithm</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">content_hash</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>

        <span class="n">n_parents</span> <span class="o">=</span> <span class="n">from_b255_no_0s</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
        <span class="n">parents_hash_algorithm</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">parents_hash</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>

        <span class="c1"># Check block rules that can and need only be checked in the context</span>
        <span class="c1"># of a running blockchain:</span>
        <span class="k">if</span> <span class="n">live</span><span class="p">:</span>
            <span class="c1"># Check block&#39;s parents</span>
            <span class="c1"># logger.info(f&quot;{self.name}:  read_block: Checking parents...&quot;)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_blocks_parents</span><span class="p">(</span><span class="n">parents</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  read_block: Checked parents: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;invalid&quot;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: blockchain_manager.Readblock: &quot;</span>
                    <span class="s2">&quot;self.check_blocks_parents returned &#39;invalid&#39;.  &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Topics: </span><span class="si">{</span><span class="n">topics</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;confirmed&quot;</span><span class="p">:</span>
                <span class="n">parents_confirmed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;unconfirmed&quot;</span><span class="p">:</span>
                <span class="n">parents_confirmed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;BUG - Blockchain.read_block: There is a bug in &quot;</span>
                    <span class="s2">&quot;blockchain_manager.self.check_blocks_parents, it &quot;</span>
                    <span class="s2">&quot;didn&#39;t return a return code&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parents</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  Genesis block!&quot;</span><span class="p">)</span>

            <span class="c1"># Check block&#39;s timestamp is in the past</span>
            <span class="k">if</span> <span class="n">creation_time</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s2">&quot;Received a block with a timestamp in the future: &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">creation_time</span><span class="si">}</span><span class="s2">. This is most likely due to &quot;</span>
                        <span class="s2">&quot;badly synchronised node clocks, but could also be &quot;</span>
                        <span class="s2">&quot;due to an ill-informed forgery attempt.&quot;</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># creating a new block object from the decoded block data</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">Block</span><span class="o">.</span><span class="n">from_metadata</span><span class="p">(</span>
            <span class="n">blockchain_version</span><span class="o">=</span><span class="n">blockchain_version</span><span class="p">,</span>
            <span class="n">creator_id</span><span class="o">=</span><span class="n">creator_id</span><span class="p">,</span>
            <span class="n">creation_time</span><span class="o">=</span><span class="n">creation_time</span><span class="p">,</span>
            <span class="n">topics</span><span class="o">=</span><span class="n">topics</span><span class="p">,</span>
            <span class="n">content_length</span><span class="o">=</span><span class="n">content_length</span><span class="p">,</span>
            <span class="n">content_hash_algorithm</span><span class="o">=</span><span class="n">content_hash_algorithm</span><span class="p">,</span>
            <span class="n">content_hash</span><span class="o">=</span><span class="n">content_hash</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
            <span class="n">n_parents</span><span class="o">=</span><span class="n">n_parents</span><span class="p">,</span>
            <span class="n">parents_hash_algorithm</span><span class="o">=</span><span class="n">parents_hash_algorithm</span><span class="p">,</span>
            <span class="n">parents_hash</span><span class="o">=</span><span class="n">parents_hash</span><span class="p">,</span>
            <span class="n">parents</span><span class="o">=</span><span class="n">parents</span><span class="p">,</span>
            <span class="n">ipfs_cid</span><span class="o">=</span><span class="n">ipfs_cid</span><span class="p">,</span>
            <span class="n">file_data</span><span class="o">=</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">block_data</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">block</span><span class="o">.</span><span class="n">generate_id</span><span class="p">()</span>

        <span class="c1"># making sure the block&#39;s block_hash is correct</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">block</span><span class="o">.</span><span class="n">check_integrity</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  The received block is not valid!Removing &quot;</span>
                <span class="s2">&quot;block-file from IPFS storage&quot;</span>
            <span class="p">)</span>
            <span class="c1"># remove block-file from IPFS storage</span>
            <span class="n">ipfs</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ipfs_cid</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  Block from </span><span class="si">{</span><span class="n">topics</span><span class="si">}</span><span class="s2"> decoded.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">live</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">block</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">parents_confirmed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blocks_to_confirm_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="c1"># add block to unconfirmed_blocks if it isn&#39;t already there</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">[</span>
                <span class="n">b</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unconfirmed_blocks</span>
                <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">short_id</span> <span class="o">==</span> <span class="n">block</span><span class="o">.</span><span class="n">short_id</span>
            <span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unconfirmed_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blocks_to_confirm_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">important</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  Block&#39;s parents not all confirmed, added to &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;blocks_to_confirm.&quot;</span>
            <span class="p">)</span>
            <span class="c1"># logger.important((</span>
            <span class="c1">#     f&quot;Unconfirmed blocks: {len(self.unconfirmed_blocks)}\n\n&quot;+</span>
            <span class="c1">#     &quot;\n\n&quot;.join([</span>
            <span class="c1">#         f&quot;{block.long_id}&quot;</span>
            <span class="c1">#          for block in self.unconfirmed_blocks</span>
            <span class="c1">#      ])</span>
            <span class="c1">#      +&quot;\n\n&quot;</span>
            <span class="c1"># ))</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># parents_confirmed == True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  All in order with the new block.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blocks_to_confirm_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="n">_update_btf</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">short_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks_to_find</span>
            <span class="k">if</span> <span class="n">_update_btf</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blocks_to_find</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">short_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blocks_to_confirm_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">_update_btf</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_on_unconfirmed_blocks</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">block</span></div>


<div class="viewcode-block" id="Blockchain.check_blocks_parents">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.Blockchain.check_blocks_parents">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_blocks_parents</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">parents</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bytearray</span><span class="p">],</span> <span class="n">got_unconf_blocks_lock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a block has a valid parent list.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_alive</span><span class="p">()</span>  <span class="c1"># ensure this Blockchain object isn&#39;t shutting down</span>

        <span class="c1"># copy parents list because we&#39;ll need to edit it in one of the checks</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">parents</span><span class="p">)</span>
        <span class="n">genesis_short_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_genesis_block_id</span><span class="p">:</span>
            <span class="n">genesis_short_id</span> <span class="o">=</span> <span class="n">short_from_long_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_genesis_block_id</span><span class="p">)</span>

        <span class="c1"># Check special case first two genesis blocks:</span>

        <span class="c1"># if the blockchain is being born</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_genesis</span><span class="p">:</span>
            <span class="c1"># if this is the first genesis block:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parents</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_known_ids</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># if the new block has as many parents</span>
                <span class="c1"># as the number of blocks known to me</span>
                <span class="k">return</span> <span class="s2">&quot;confirmed&quot;</span>

            <span class="c1"># If this is the second genesis block</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">number_of_known_ids</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="ow">and</span> <span class="n">parents</span> <span class="o">==</span> <span class="p">[</span><span class="n">genesis_short_id</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;confirmed&quot;</span>

        <span class="c1"># Ensure there aren&#39;t duplicates in parents:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">are_elements_unique</span><span class="p">(</span><span class="n">parents</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  Block has repeated parents. &quot;</span>
                <span class="s2">&quot;Block not accepted.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;invalid&quot;</span>

        <span class="c1"># Ensure there are at least two parents:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parents</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Block has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">parents</span><span class="p">)</span><span class="si">}</span><span class="s2"> parents&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;invalid&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">genesis_short_id</span><span class="p">:</span>
            <span class="n">genesis_short_id</span> <span class="o">=</span> <span class="n">short_from_long_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_genesis_block</span><span class="p">())</span>

        <span class="c1"># Checking if we know all of the parent blocks</span>
        <span class="n">known_parents_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_block_known</span><span class="p">(</span><span class="n">parent</span><span class="p">):</span>
                <span class="n">known_parents_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># parent is not known</span>
                <span class="c1"># append parent to blocks_to_find (if it isn&#39;t already)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">got_unconf_blocks_lock</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Acquiring lock...&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">blocks_to_confirm_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">parent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks_to_find</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">blocks_to_find</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">got_unconf_blocks_lock</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">blocks_to_confirm_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Released lock.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">known_parents_count</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">parents</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;unconfirmed&quot;</span>

        <span class="c1"># ensure no parents are ancestors of each other</span>
        <span class="c1"># remove genesis parent if block has only one direct parent</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parents</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">genesis_short_id</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
            <span class="n">parents</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">genesis_short_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parents</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_ancestors</span><span class="p">(</span><span class="n">parents</span><span class="p">)):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  Some of the block&#39;s parents are &quot;</span>
                    <span class="s2">&quot;ancestors of each other.&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;invalid&quot;</span>

        <span class="k">return</span> <span class="s2">&quot;confirmed&quot;</span></div>


<div class="viewcode-block" id="Blockchain.remove_ancestors">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.Blockchain.remove_ancestors">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_ancestors</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">blocks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bytearray</span><span class="p">],</span> <span class="n">short_ids</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bytearray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given a list of blocks, remove any which is an ancestors of another.</span>

<span class="sd">        Args:</span>
<span class="sd">            blocks (list): list of Block objects or block IDs</span>
<span class="sd">            short_ids (bool): if the provided block IDs are short not long</span>
<span class="sd">        Returns:</span>
<span class="sd">            list: long IDs of blocks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.block_ancestry</span><span class="w"> </span><span class="kn">import</span> <span class="n">remove_ancestors</span>

        <span class="n">long_ids</span> <span class="o">=</span> <span class="n">remove_ancestors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blocks</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">short_ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">short_from_long_id</span><span class="p">(</span><span class="n">long_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">long_id</span> <span class="ow">in</span> <span class="n">long_ids</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">long_ids</span></div>


<div class="viewcode-block" id="Blockchain.check_on_unconfirmed_blocks">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.Blockchain.check_on_unconfirmed_blocks">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_on_unconfirmed_blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if unconfirmed blocks can be validated now.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_alive</span><span class="p">()</span>  <span class="c1"># ensure this Blockchain object isn&#39;t shutting down</span>

        <span class="n">num_confirmed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocks_to_confirm_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unconfirmed_blocks</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_blocks_parents</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">parents</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;invalid&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unconfirmed_blocks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;confirmed&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unconfirmed_blocks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">short_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks_to_find</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">blocks_to_find</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">short_id</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Confirmed a previously unconfirmed block!&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_block_confirmed</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
                <span class="n">num_confirmed</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocks_to_confirm_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">num_confirmed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_on_unconfirmed_blocks</span><span class="p">()</span></div>

        <span class="c1"># logger.info(</span>
        <span class="c1">#     f&quot;{self.name} Unconfirmed Blocks: {len(self.unconfirmed_blocks)}&quot;</span>
        <span class="c1"># )</span>
        <span class="c1"># logger.info(f&quot;{self.name} Blocks to Find: {len(self.blocks_to_find)}&quot;)</span>

<div class="viewcode-block" id="Blockchain.look_for_blocks_to_find">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.Blockchain.look_for_blocks_to_find">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">look_for_blocks_to_find</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Try to get blocks we have heard about but don&#39;t have.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_alive</span><span class="p">()</span>  <span class="c1"># ensure this Blockchain object isn&#39;t shutting down</span>

        <span class="k">for</span> <span class="n">blocks_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks_to_find</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">download_and_process_block</span><span class="p">(</span><span class="n">blocks_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="Blockchain.blocks_finder_thread">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.Blockchain.blocks_finder_thread">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">blocks_finder_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Try to get blocks we have heard about but don&#39;t have.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_alive</span><span class="p">()</span>  <span class="c1"># ensure this Blockchain object isn&#39;t shutting down</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terminate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">look_for_blocks_to_find</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_on_unconfirmed_blocks</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks_finder_thread_cycle_duration_s</span><span class="p">)</span></div>


<div class="viewcode-block" id="Blockchain.create_invitation">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.Blockchain.create_invitation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_invitation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">one_time</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">shared</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a code which another node can use to join this blockchain.</span>

<span class="sd">        Args:</span>
<span class="sd">            one_time (bool): whether or not the invitation should be discarded</span>
<span class="sd">                    once a peer uses it to join the blockchain</span>
<span class="sd">            shared (bool): whether or not the invitation should be transferred</span>
<span class="sd">                    to other peers when they join the blockchain</span>
<span class="sd">                    (implies one_time=False)</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: the invitation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_alive</span><span class="p">()</span>  <span class="c1"># ensure this Blockchain object isn&#39;t shutting down</span>

        <span class="c1"># &#39;one_time == True&#39; makes no sense if shared == True</span>
        <span class="k">if</span> <span class="n">shared</span><span class="p">:</span>
            <span class="n">one_time</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">private_key</span> <span class="o">=</span> <span class="n">generate_key</span><span class="p">()</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;blockchain_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">blockchain_id</span><span class="p">,</span>
            <span class="s2">&quot;peers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ipfs_peer_id</span><span class="p">],</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">private_key</span><span class="o">.</span><span class="n">public_key</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">(),</span>
            <span class="s2">&quot;one_time&quot;</span><span class="p">:</span> <span class="n">one_time</span><span class="p">,</span>
            <span class="s2">&quot;shared&quot;</span><span class="p">:</span> <span class="n">shared</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">invitation</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invitations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">invitation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_invitations</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">invitation</span></div>


<div class="viewcode-block" id="Blockchain.get_invitation">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.Blockchain.get_invitation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_invitation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given the &#39;key&#39; part of an invitation, return the invitation.</span>

<span class="sd">        If the whole invitation code is passed, returns the invitation,</span>
<span class="sd">        possibly with updated properties (if the user passed an older version</span>
<span class="sd">        of the invitation).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_alive</span><span class="p">()</span>  <span class="c1"># ensure this Blockchain object isn&#39;t shutting down</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">key</span><span class="p">)[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">for</span> <span class="n">invitation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">invitations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">invitation</span><span class="p">)[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">invitation</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Blockchain.delete_invitation">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.Blockchain.delete_invitation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete_invitation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete an invitation.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_alive</span><span class="p">()</span>  <span class="c1"># ensure this Blockchain object isn&#39;t shutting down</span>

        <span class="n">invitation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_invitation</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">invitation</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invitations</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">invitation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_invitations</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Blockchain.on_join_request_received">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.Blockchain.on_join_request_received">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_join_request_received</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">conversation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">peer_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process a join request from a new node.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_alive</span><span class="p">()</span>  <span class="c1"># ensure this Blockchain object isn&#39;t shutting down</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  on_join_request_received: received join Request&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peer_monitor</span><span class="o">.</span><span class="n">register_contact_event</span><span class="p">(</span><span class="n">peer_id</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># TODO: FIX THIS DELAY WITH TRNAMISSION RETRIES</span>

            <span class="c1"># conv.join(conversation_name, peer_id, conversation_name)</span>
            <span class="n">conv</span> <span class="o">=</span> <span class="n">ipfs</span><span class="o">.</span><span class="n">join_conversation</span><span class="p">(</span>
                <span class="n">conversation_name</span><span class="p">,</span>
                <span class="n">peer_id</span><span class="p">,</span>
                <span class="n">conversation_name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;WJR: joined conversation&quot;</span><span class="p">)</span>
            <span class="n">invitation</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">JOIN_COMMS_TIMEOUT_S</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_invitation</span><span class="p">(</span><span class="n">invitation</span><span class="p">):</span>
                <span class="n">success</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">say</span><span class="p">(</span>
                    <span class="s2">&quot;All right.&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">timeout_sec</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">JOIN_COMMS_TIMEOUT_S</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;WJR: failed to respond to requester.&quot;</span><span class="p">)</span>
                    <span class="n">conv</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                    <span class="k">return</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;replied&quot;</span><span class="p">)</span>
                <span class="n">appdata_zip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_appdata</span><span class="p">()</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">check_on_progress</span><span class="p">(</span><span class="n">progress</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Sending appdata file: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">progress</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">progress</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">appdata_zip</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;WJR: Transmitting appdata...&quot;</span><span class="p">)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">conv</span><span class="o">.</span><span class="n">transmit_file</span><span class="p">(</span>
                    <span class="n">appdata_zip</span><span class="p">,</span>
                    <span class="s2">&quot;Here you go&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
                    <span class="n">progress_handler</span><span class="o">=</span><span class="n">check_on_progress</span><span class="p">,</span>
                    <span class="n">transm_send_timeout_sec</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">JOIN_COMMS_TIMEOUT_S</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;WJR: Transmitted appdata!&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">invitation</span><span class="p">)[</span><span class="s2">&quot;one_time&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delete_invitation</span><span class="p">(</span><span class="n">invitation</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:  on_join_request_received: Couldn&#39;t find &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Invitation </span><span class="si">{</span><span class="n">invitation</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">conv</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="s2">&quot;Don&#39;t recognise Invitation.&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
            <span class="n">conv</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;on_join_request_received: Unhandled error </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">: &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">conv</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span></div>


<div class="viewcode-block" id="Blockchain.terminate">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.Blockchain.terminate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop running this blockchain.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terminate</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_terminate</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terminate_networking</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_lis</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: Shut down.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Blockchain.check_alive">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.Blockchain.check_alive">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Raise an exception if this blockchain is not running.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terminate</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">function_name</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">This Walytis_Beta Blockchain has been &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;terminated!</span><span class="se">\n</span><span class="si">{</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_stack</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">BlockchainTerminatedError</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span></div>
</div>



<span class="n">blockchains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Blockchain</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>


<div class="viewcode-block" id="get_blockchain_names">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.get_blockchain_names">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_blockchain_names</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a list of our blockchains&#39; names.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">blockchain</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">blockchain</span> <span class="ow">in</span> <span class="n">blockchains</span><span class="p">]</span></div>



<div class="viewcode-block" id="get_blockchain_ids">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.get_blockchain_ids">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_blockchain_ids</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a list of our blockchains&#39; IDs.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">blockchain</span><span class="o">.</span><span class="n">blockchain_id</span> <span class="k">for</span> <span class="n">blockchain</span> <span class="ow">in</span> <span class="n">blockchains</span><span class="p">]</span></div>



<div class="viewcode-block" id="join_blockchain">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.join_blockchain">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">join_blockchain</span><span class="p">(</span>
    <span class="n">invitation</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="n">blockchain_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Blockchain</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Join a blockchain using a invitation generated by a blockchain member.</span>

<span class="sd">    Args:</span>
<span class="sd">        invitation (str): the invitation generated by a blockchain member</span>
<span class="sd">        blockchain_name (str): the user-chosen name for the blockchain</span>

<span class="sd">    Returns:</span>
<span class="sd">        Blockchain: the newly joined blockchain object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">invitation</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">invitation_d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">invitation</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">invitation_d</span> <span class="o">=</span> <span class="n">invitation</span>

    <span class="n">blockchain_id</span> <span class="o">=</span> <span class="n">invitation_d</span><span class="p">[</span><span class="s2">&quot;blockchain_id&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">blockchain_id</span> <span class="ow">in</span> <span class="n">get_blockchain_ids</span><span class="p">():</span>
        <span class="n">logger_join</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Walytis_Beta.join_blockchain: Blockchain already exists&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">get_blockchain</span><span class="p">(</span><span class="n">blockchain_id</span><span class="p">)</span>
    <span class="n">peers</span> <span class="o">=</span> <span class="n">invitation_d</span><span class="p">[</span><span class="s2">&quot;peers&quot;</span><span class="p">]</span>
    <span class="n">logger_join</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Joining blockchain...&quot;</span><span class="p">)</span>
    <span class="n">peers_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">peer</span> <span class="ow">in</span> <span class="n">peers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">peer</span> <span class="o">==</span> <span class="n">ipfs</span><span class="o">.</span><span class="n">peer_id</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">peers_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">logger_join</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WJ: trying peer </span><span class="si">{</span><span class="n">peer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">tempdir</span> <span class="o">=</span> <span class="n">create_temp_dir</span><span class="p">()</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger_join</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;WJ: starting conversation&quot;</span><span class="p">)</span>
            <span class="n">conv</span> <span class="o">=</span> <span class="n">ipfs</span><span class="o">.</span><span class="n">start_conversation</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">blockchain_id</span><span class="si">}</span><span class="s2">: JoinRequest: </span><span class="si">{</span><span class="n">ipfs</span><span class="o">.</span><span class="n">peer_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">peer</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">blockchain_id</span><span class="si">}</span><span class="s2">: JoinRequest&quot;</span><span class="p">,</span>
                <span class="n">download_dir</span><span class="o">=</span><span class="n">tempdir</span><span class="p">,</span>
                <span class="n">timeout_sec</span><span class="o">=</span><span class="n">JOIN_COMMS_TIMEOUT_S</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logger_join</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Asking peer for AppdataZip&quot;</span><span class="p">)</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

            <span class="n">success</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">say</span><span class="p">(</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">invitation_d</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
                <span class="n">timeout_sec</span><span class="o">=</span><span class="n">JOIN_COMMS_TIMEOUT_S</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">logger_join</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;WJ: Failed to communicate with peer.&quot;</span><span class="p">)</span>
                <span class="n">conv</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                <span class="k">continue</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">JOIN_COMMS_TIMEOUT_S</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">:</span>
                <span class="n">logger_join</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Join: No response from peer&quot;</span><span class="p">)</span>
                <span class="n">conv</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;All right.&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">():</span>
                <span class="n">logger_join</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Join: Awaiting appdata file....&quot;</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">listen_for_file</span><span class="p">(</span><span class="n">no_coms_timeout</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">:</span>
                    <span class="n">logger_join</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Join: No file response from peer&quot;</span><span class="p">)</span>
                    <span class="n">conv</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                    <span class="k">continue</span>
                <span class="n">appdata_zipfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempdir</span><span class="p">,</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;filepath&quot;</span><span class="p">])</span>
                <span class="n">logger_join</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Join: Received join Appdata! </span><span class="si">{</span><span class="n">appdata_zipfile</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">blockchain</span> <span class="o">=</span> <span class="n">join_blockchain_from_zip</span><span class="p">(</span>
                    <span class="n">blockchain_id</span><span class="p">,</span> <span class="n">appdata_zipfile</span><span class="p">,</span> <span class="n">blockchain_name</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">blockchain</span><span class="p">:</span>  <span class="c1"># if joining was successful</span>
                    <span class="n">logger_join</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Join: Joined blockchain!&quot;</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">appdata_zipfile</span><span class="p">)</span>
                    <span class="n">conv</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tempdir</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">_peer</span> <span class="ow">in</span> <span class="n">peers</span><span class="p">:</span>
                        <span class="n">blockchain</span><span class="o">.</span><span class="n">peer_monitor</span><span class="o">.</span><span class="n">register_contact_event</span><span class="p">(</span><span class="n">_peer</span><span class="p">)</span>
                        <span class="k">pass</span>
                    <span class="k">return</span> <span class="n">blockchain</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">appdata_zipfile</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">appdata_zipfile</span><span class="p">)</span>
                    <span class="n">logger_join</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Join: Joining from zip file failed&quot;</span><span class="p">)</span>
                    <span class="n">conv</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger_join</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Join: Peer refused join request, peer said:&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">conv</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="n">conv</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger_join</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Join: Unhandled error </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">conv</span><span class="p">:</span>
                    <span class="n">conv</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tempdir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tempdir</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tempdir</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to join blockchain ater trying </span><span class="si">{</span><span class="n">peers_count</span><span class="si">}</span><span class="s2"> peers.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="join_blockchain_from_cid">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.join_blockchain_from_cid">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">join_blockchain_from_cid</span><span class="p">(</span>
    <span class="n">blockchain_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">blockchain_data_cid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">blockchain_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Blockchain</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Join an existing live blockchain from its data published on IPFS.</span>

<span class="sd">    Args:</span>
<span class="sd">        blockchain_id (str): the id of the blockchain</span>
<span class="sd">        blockchain_data_cid (str): path of the zip file containing the</span>
<span class="sd">                                    blockchain&#39;s data</span>
<span class="sd">        blockchain_name (str): the user-chosen name for the blockchain</span>

<span class="sd">    Returns:</span>
<span class="sd">        Blockchain: the blockchain object representing the joined blockchain</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger_join</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Joining blockchain from CID: </span><span class="si">{</span><span class="n">blockchain_data_cid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">bc_appdata_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_walytis_appdata_dir</span><span class="p">(),</span> <span class="n">blockchain_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">[</span>
        <span class="n">bc</span>
        <span class="k">for</span> <span class="n">bc</span> <span class="ow">in</span> <span class="n">blockchains</span>
        <span class="k">if</span> <span class="n">bc</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="n">blockchain_name</span><span class="p">,</span> <span class="n">blockchain_id</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">bc</span><span class="o">.</span><span class="n">blockchain_id</span> <span class="ow">in</span> <span class="p">(</span><span class="n">blockchain_name</span><span class="p">,</span> <span class="n">blockchain_id</span><span class="p">)</span>
    <span class="p">]:</span>
        <span class="n">logger_join</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;blockchain_manager.join_blockchain_from_cid:&quot;</span>
            <span class="s2">&quot;blockchain already exists&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bc_appdata_path</span><span class="p">):</span>
        <span class="n">logger_join</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;blockchain_manager.join_blockchain_from_cid:&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;blockchain&#39;s appdata path already exists&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">logger_join</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;WJ: getting join data from IPFS...&quot;</span><span class="p">)</span>
    <span class="n">ipfs</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">blockchain_data_cid</span><span class="p">,</span> <span class="n">dest_path</span><span class="o">=</span><span class="n">bc_appdata_path</span><span class="p">)</span>
    <span class="n">logger_join</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;WJ: got join data from IPFS!&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">check_and_start_joined_blockchain</span><span class="p">(</span><span class="n">blockchain_id</span><span class="p">,</span> <span class="n">blockchain_name</span><span class="p">)</span></div>



<div class="viewcode-block" id="join_blockchain_from_zip">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.join_blockchain_from_zip">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">join_blockchain_from_zip</span><span class="p">(</span>
    <span class="n">blockchain_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">blockchain_zip_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">blockchain_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Blockchain</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Join an existing live blockchain from zip file containing its data.</span>

<span class="sd">    Paramaters:</span>
<span class="sd">        blockchain_id(str): the id of the blockchain</span>
<span class="sd">        blockchain_zip_path: path of the zip file containing the blockchain&#39;s</span>
<span class="sd">                                data</span>
<span class="sd">        blockchain_name(str): the chosen name for the blockchain</span>
<span class="sd">    Returns:</span>
<span class="sd">        Blockchain: the blockchain object representing the joined blockchain</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bc_appdata_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_walytis_appdata_dir</span><span class="p">(),</span> <span class="n">blockchain_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">[</span>
        <span class="n">bc</span>
        <span class="k">for</span> <span class="n">bc</span> <span class="ow">in</span> <span class="n">blockchains</span>
        <span class="k">if</span> <span class="n">bc</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="n">blockchain_name</span><span class="p">,</span> <span class="n">blockchain_id</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">bc</span><span class="o">.</span><span class="n">blockchain_id</span> <span class="ow">in</span> <span class="p">(</span><span class="n">blockchain_name</span><span class="p">,</span> <span class="n">blockchain_id</span><span class="p">)</span>
    <span class="p">]:</span>
        <span class="n">logger_join</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;blockchain_manager.join_blockchain_from_zip:&quot;</span>
            <span class="s2">&quot;blockchain already exists&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bc_appdata_path</span><span class="p">):</span>
        <span class="n">logger_join</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;blockchain_manager.join_blockchain_from_zip:&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;blockchain&#39;s appdata path already exists&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">shutil</span><span class="o">.</span><span class="n">unpack_archive</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">blockchain_zip_path</span><span class="p">),</span> <span class="n">bc_appdata_path</span><span class="p">,</span> <span class="s2">&quot;zip&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">check_and_start_joined_blockchain</span><span class="p">(</span><span class="n">blockchain_id</span><span class="p">,</span> <span class="n">blockchain_name</span><span class="p">)</span></div>



<div class="viewcode-block" id="check_and_start_joined_blockchain">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.check_and_start_joined_blockchain">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_and_start_joined_blockchain</span><span class="p">(</span>
    <span class="n">blockchain_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">blockchain_name</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Blockchain</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check a blockchain&#39;s validity and run it.</span>

<span class="sd">    Called after a newly joined blockchain&#39;s appdata has been installed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">blockchain</span><span class="p">:</span> <span class="n">Blockchain</span> <span class="o">=</span> <span class="n">Blockchain</span><span class="p">(</span>
            <span class="n">blockchain_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">blockchain_name</span>
        <span class="p">)</span>
        <span class="n">logger_join</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;WJ: Reconstructed blockchain.&quot;</span><span class="p">)</span>

        <span class="n">blockchains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blockchain</span><span class="p">)</span>

        <span class="n">genesis_block</span> <span class="o">=</span> <span class="n">blockchain</span><span class="o">.</span><span class="n">load_block</span><span class="p">(</span>
            <span class="n">blockchain</span><span class="o">.</span><span class="n">load_latest_block_ids</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">genesis_block</span><span class="p">:</span>
            <span class="n">logger_join</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Joining blockchain cancelled because it seems &quot;</span>
                <span class="s2">&quot;corrupt: we couldn&#39;t find its genesis block. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">blockchain_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">delete_blockchain</span><span class="p">(</span><span class="n">blockchain_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">blockchain_ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">genesis_block</span><span class="o">.</span><span class="n">ipfs_cid</span> <span class="o">==</span> <span class="n">blockchain_id</span>
            <span class="ow">or</span> <span class="n">blockchain_id</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;BrenthyUpdates&quot;</span><span class="p">,</span> <span class="s2">&quot;BrenthyUpdatesTEST&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">logger_join</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Joining blockchain cancelled because the &quot;</span>
                <span class="s2">&quot;blockchain ID did not match the genesis block. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">blockchain_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">blockchain_ok</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">genesis_block</span><span class="o">.</span><span class="n">parents</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger_join</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Joining blockchain canceled because the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;genesis block has parents. </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">genesis_block</span><span class="o">.</span><span class="n">parents</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">blockchain_ok</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">blockchain_ok</span><span class="p">:</span>
            <span class="n">delete_blockchain</span><span class="p">(</span><span class="n">blockchain_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">logger_join</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;WJ: checked joined blockchain&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">blockchain</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">logger_join</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="create_blockchain">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.create_blockchain">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_blockchain</span><span class="p">(</span><span class="n">blockchain_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Blockchain</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a new blockchain.</span>

<span class="sd">    Args:</span>
<span class="sd">        blockchain_name (str): the id of the blockchain to create (unique)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Blockchain: the newly created Blockchain object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">blockchain_name</span>
        <span class="ow">and</span> <span class="p">[</span><span class="n">bc</span> <span class="k">for</span> <span class="n">bc</span> <span class="ow">in</span> <span class="n">blockchains</span> <span class="k">if</span> <span class="n">bc</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">blockchain_name</span><span class="p">]</span>
        <span class="ow">or</span> <span class="p">[</span><span class="n">bc</span> <span class="k">for</span> <span class="n">bc</span> <span class="ow">in</span> <span class="n">blockchains</span> <span class="k">if</span> <span class="n">bc</span><span class="o">.</span><span class="n">blockchain_id</span> <span class="o">==</span> <span class="n">blockchain_name</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;blockchain_manager.create_blockchain: blockchain already exists&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># create new blockchain</span>
    <span class="n">blockchain</span> <span class="o">=</span> <span class="n">Blockchain</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">blockchain_name</span><span class="p">)</span>
    <span class="n">blockchains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blockchain</span><span class="p">)</span>
    <span class="c1"># app_data.SaveBlockchainsList([bc.name for bc in blockchains])</span>

    <span class="k">return</span> <span class="n">blockchain</span></div>



<div class="viewcode-block" id="delete_blockchain">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.delete_blockchain">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_blockchain</span><span class="p">(</span><span class="n">blockchain_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete a blockchain.</span>

<span class="sd">    Args:</span>
<span class="sd">        blockchain_id (bytearray): the id of the blockchain to delete</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool success: whether or not the specified blockchain was found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;trying to delete blockchain&quot;</span><span class="p">)</span>
    <span class="n">blockchain_search</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">bc</span> <span class="k">for</span> <span class="n">bc</span> <span class="ow">in</span> <span class="n">blockchains</span> <span class="k">if</span> <span class="n">bc</span><span class="o">.</span><span class="n">blockchain_id</span> <span class="o">==</span> <span class="n">blockchain_id</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">blockchain_search</span><span class="p">:</span>
        <span class="n">blockchain</span><span class="p">:</span> <span class="n">Blockchain</span> <span class="o">=</span> <span class="n">blockchain_search</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">important</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;deleting blockchain </span><span class="si">{</span><span class="n">blockchain</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">blockchain</span> <span class="ow">in</span> <span class="n">blockchains</span><span class="p">:</span>
            <span class="n">blockchains</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">blockchain</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;walytis_beta.delete_blockchain: &quot;</span>
                <span class="s2">&quot;blockchain not in blockchains list&quot;</span>
            <span class="p">)</span>
        <span class="n">blockchain</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">blockchain</span><span class="o">.</span><span class="n">_blocks_finder_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">blockchain</span><span class="o">.</span><span class="n">block_requester_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">blockchain</span><span class="o">.</span><span class="n">index_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">blockchain</span><span class="o">.</span><span class="n">appdata_dir</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">blockchain</span><span class="o">.</span><span class="n">appdata_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;delete_blockchain: blockchain&#39;s appdata path &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;doesn&#39;t exist </span><span class="si">{</span><span class="n">blockchain</span><span class="o">.</span><span class="n">appdata_dir</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">blockchain</span><span class="o">.</span><span class="n">index_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">important</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;deleted blockchain </span><span class="si">{</span><span class="n">blockchain</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Walytis_Beta:remaining blockchains: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">[</span><span class="n">blockchain</span><span class="o">.</span><span class="n">name</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">blockchain</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">blockchains</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;delete_blockchain: no such blockchain </span><span class="si">{</span><span class="n">blockchain_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="get_blockchains">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.get_blockchains">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_blockchains</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Blockchain</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a list of the currently running blockchains.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">blockchains</span></div>



<div class="viewcode-block" id="get_blockchain">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.get_blockchain">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_blockchain</span><span class="p">(</span><span class="n">blockchain_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Blockchain</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a blockchain object given its ID.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">blockchain</span> <span class="ow">in</span> <span class="n">blockchains</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">blockchain</span><span class="o">.</span><span class="n">blockchain_id</span> <span class="o">==</span> <span class="n">blockchain_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">blockchain</span>
    <span class="k">return</span> <span class="kc">None</span></div>



<span class="n">require_blockchain_paths</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;KnownBlocksIndex&quot;</span><span class="p">,</span> <span class="s2">&quot;ReceivedBlocks&quot;</span><span class="p">}</span>


<div class="viewcode-block" id="run_blockchains">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.run_blockchains">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">run_blockchains</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Start running our blockchains.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">get_walytis_appdata_dir</span><span class="p">():</span>
        <span class="n">error_message</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Walytis appdata directory not set!</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Call `walytis_api.set_appdata_dir() before calling run_blockchains`&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
    <span class="n">blockchain_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">important</span><span class="p">(</span>
        <span class="s2">&quot;Loading blockchains from &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">get_walytis_appdata_dir</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">blockchain_id</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">get_walytis_appdata_dir</span><span class="p">()):</span>
        <span class="n">blockchain_data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">get_walytis_appdata_dir</span><span class="p">(),</span> <span class="n">blockchain_id</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">blockchain_data_dir</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">require_blockchain_paths</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">blockchain_data_dir</span><span class="p">))</span>
            <span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">important</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping directory </span><span class="si">{</span><span class="n">blockchain_data_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">blockchain_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blockchain_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># delete uncleanedup file</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">blockchain_data_dir</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">important</span><span class="p">(</span><span class="s2">&quot;Running blockchains:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">blockchain_id</span> <span class="ow">in</span> <span class="n">blockchain_ids</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">get_blockchain</span><span class="p">(</span><span class="n">blockchain_id</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">important</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;run_blockchains: already loaded: </span><span class="si">{</span><span class="n">blockchain_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">blockchain</span> <span class="o">=</span> <span class="n">Blockchain</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">blockchain_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">important</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; - </span><span class="si">{</span><span class="n">blockchain</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">blockchains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blockchain</span><span class="p">)</span></div>



<div class="viewcode-block" id="terminate">
<a class="viewcode-back" href="../../walytis_beta.walytis_beta.html#walytis_beta.walytis_beta.terminate">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">terminate</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stop all running blockchains.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Terminating all blockchains...&quot;</span><span class="p">)</span>
    <span class="k">global</span> <span class="n">blockchains</span>
    <span class="n">threads</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Thread</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">blockchain</span> <span class="ow">in</span> <span class="n">blockchains</span><span class="p">:</span>
        <span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">blockchain</span><span class="o">.</span><span class="n">terminate</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">())</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">blockchains</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Terminated all blockchains!&quot;</span><span class="p">)</span>
    <span class="n">ipfs</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Terminated IPFS!&quot;</span><span class="p">)</span></div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=7026087e"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=46bd48cc"></script>
    </body>
</html>